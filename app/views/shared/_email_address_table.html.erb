<% 

field_name = 'recipients_array' if local_assigns[:field_name].nil?
method_name = 'recipients_as_array' if local_assigns[:method_name].nil?

%>

<div class="form-group">

    <%= label_tag field_name + '_new_recipient_field', t('activerecord.attributes.' + @model.class.name.underscore + '.' + field_name), class: 'required' %>

    <div class="input-group">
        <span class="input-group-addon">@</span>
        <input type="text" class="form-control" id="<%= field_name %>_new_recipient_field" placeholder="<%= t('helpers.receipt_email.new_recipient') %>">
        <span class="input-group-addon"><span class=" glyphicon glyphicon-plus add_recipient_btn" id="<%= field_name %>_add_recipient_btn"></span></span>
    </div>
</div>

<table id="<%= field_name %>_recipients_table" class="table table-striped table-condensed table-bordered unbreakable-table">
    <tbody>
        <% @model.public_send(method_name).each_with_index do |email_address, index| %>
        <%= render partial: 'shared/email_address', locals: {email_address: email_address, index: index, field_name: field_name} %>
        <% end %>
    </tbody>
</table>

<%= f.hidden_field field_name %>

<script>

    var temp_id = -1;
    var transient_recipients = 0;

    function already_present(email_address)
    {
        var result = false;

        $('#<%= field_name %>_recipients_table > tbody > tr').each(function() {
            if($(this).find('.recipient_email').html() == email_address) {
                result = true;
            }
        })

        return result;
    }

    function validate_recipient_email(email) {
        var regex = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
        return regex.test(email);
    }


    $('body').on('click', '.remove_recipient_btn', function() {
        id = $(this).parent().parent().find('.recipient_id').text();

        $('#<%= field_name %>_email_address_' + id).fadeOut('slow', function() {
            $('#<%= field_name %>_email_address_' + id).remove();
        });

        transient_recipients -= 1;
    });

    function formated_recipients(id)
    {
        var array = '';

        if(!id)
            id = '<%= field_name %>';

        $('#' + id + '_recipients_table > tbody > tr').each(function() {
            array = array.concat($(this).find('.recipient_email').html() + ', ');
        })

        return array.substring(0, array.length - 2);
    }

    $('#<%= field_name %>_add_recipient_btn').on('click', function() {

        email_address = $('#<%= field_name %>_new_recipient_field').val();

        if (!$('#<%= field_name %>_new_recipient_field').val())
        {
            display_form_errors('<%= t('alert.email.fill_a_recipient') %>');

        } else if(already_present(email_address))
        {
            display_form_errors('<%= t('alert.email.duplicated_recipient') %>');
        } else if (validate_recipient_email(email_address))
        {
            line = '<tr id="email_address_' + temp_id + '"><td class="recipient_id" style="display:none;">' + temp_id + '</td><td class="recipient_email">' + email_address + '</td><td class="button-wrapper"><%= link_to image_tag('delete.png', title: t('helpers.action.remove'), class: 'remove_btn'), 'javascript:void(0)', class: 'remove_recipient_btn remove_btn' %></td></tr>';
            $('#<%= field_name %>_recipients_table > tbody:last-child').append(line);
            temp_id = temp_id - 1;

            hide_all_messages();
            $('#<%= field_name %>_new_recipient_field').val('');
        } else
        {
            display_form_errors('<%= t('alert.email.invalid_recipient') %>');
        }
    });

</script>