<%= form_for @model, :html=> {:id => 'main_form'} do |f| %>

	<%= render partial: "helpers/form_errors", locals: {model: @model} %>

	<!-- TODO -->
	<%= f.hidden_field 'email_configuration_id', :value => '1' %>
	<%= f.hidden_field :id %>

	<div class="container-fluid padless">
		<div class="row">
			<div class="col-md-5">

				<div class="form-group">

					<%= f.label :recipients_array, :class => 'required' %>

					<div class="input-group">
						<span class="input-group-addon">@</span>
						<input type="text" class="form-control" id="new_recipient_field" placeholder="<%= t('helpers.email.new_recipient') %>">
						<span class="input-group-addon"><span class=" glyphicon glyphicon-plus add_recipient_btn" id="add_recipient_btn"></span></span>
						<span class="input-group-btn add_recipient_btn"/>
					</div>
				</div>

				<table id="recipients_table" class="table table-striped table-condensed table-bordered email_address_table">
					<tbody>
						<% @model.recipients_as_array.each_with_index do |email_address, index| %>
							<tr id="email_address_<%= index %>" class="email_receipt">
								<td class="recipient_id" style="display:none;"><%= index.to_s %></td>
								<td class="recipient_email"><%= email_address %></td>
								<td style="width: 30px; vertical-align:middle"><%= image_tag("delete.png", :title => t('helpers.action.remove'), :class => 'remove_receipt_btn') %> </td>
							</tr>
						<% end %>
					</tbody>
				</table>

				<%= f.hidden_field :recipients_array %>
			</div>
			<div class="col-md-7">

				<div class="container-fluid padless">
					<div class="row">
						<div class="col-sm-5 form-group">
							<%= f.label :value %>
							<div class="input-group">
								<span class="input-group-addon">R$</span>
								<%= f.text_field :value, :class => 'form-control money' %>
							</div>
						</div>
						<div class="col-sm-3 form-group">
							<%= f.label :day_of_month %>
							<%= f.text_field :day_of_month, :class => 'form-control day_of_month' %>
						</div>
						<div class="col-sm-4 form-group">
							<%= f.label :company %>
							<%= f.collection_select(:company_id, Company.where(group: 1), :id, :trading_name, {:include_blank => t('helpers.select.prompt')}, {class: "form-control", :disabled => f.object.persisted?}) %>
						</div>
					</div>
				</div>

				<!-- <div class="form-group">
					<%# f.label :type %>
					<%# f.collection_select(:type, EmailType.all, :id, :name, {:include_blank => t('helpers.select.prompt')}, {class: "form-control", :disabled => f.object.persisted?}) %>
				</div> -->
			</div>
		</div>
	</div>

	<div class="form-group">
		<%= f.label :title %>
		<%= text_field_tag "title", @model.title, :disabled => true, :class => "form-control" %>
	</div>

	<div class="form-group">
		<%= f.label :body %>
		<span style="float:right">
			<% I18n.with_options(scope: 'activerecord.attributes.email') do |i18n| %>
			<div class="btn-group">
				<button type="button" class="btn btn-primary btn-xs" id="add_company_to_body_btn"><%= i18n.t :company %></button>
				<button type="button" class="btn btn-primary btn-xs" id="add_value_to_body_btn"><%= i18n.t :value %></button>
				<button type="button" class="btn btn-primary btn-xs" id="add_competence_to_body_btn"><%= i18n.t :competence %></button>
			</div>
			<% end %>
		</span>
		<%= f.text_area :body, size: "24x6", :class => 'form-control' %>
	</div>

	<% if !@model.new_record? %>
		<div class="panel-group">
		<div class="panel panel-default">
			<div class="panel-heading">
				<h4 class="panel-title"><a data-toggle="collapse" href="#collapse_history"><%= t('audit.history') %></a></h4>
			</div>
			<div id="collapse_history" class="panel-collapse collapse">
				<div class="panel-body" style="margin: 0; padding: 0;">
					<table id="history_table" class="table table-striped table-condensed">
						<tr>
							<th><%= t('audit.when') %></th>
							<th><%= t('audit.value') %></th>
							<th><%= t('audit.type') %></th>
							<th><%= t('audit.who') %></th>
						</tr>

						<% @model.history.each do |history| %>
						<tr>
							<td><%= l(history.created_at, format: :really_short) %></td>
							<td><%= ActionController::Base.helpers.number_to_currency(history.value) %></td>
							<td><%= history.send_type_desc %></td>
							<td><%= history.user.name %></td>
						</tr>
						<% end %>
					</table>
				</div>
				<div class="panel-footer">
				</div>
			</div>
		</div>
	</div>
	<% end %>

	<%= render partial: "helpers/form_buttons", locals: {model: @model, f: f} -%>

<% end %>


<%= render partial: "helpers/form_helper", locals: {model: @model} %>
<%= render partial: "modals" %>

<script>
	<% if !@model.new_record? %>

		function a()
		{
			jQuery.noConflict();
			$('#resend_email_modal').modal('show');
		}

		$('.resend_btn').click(function(ev) {

			clean_resend_modal();
			$('#resend_email_form').get(0).setAttribute('action', '/emails/' + <%= @model.id.to_s %> + '/resend');
			$('.modal_company_name').text('<%= @model.company.simple_name %>');
			a();
		});

		$('.send_test_btn').click(function(ev) {

			clean_send_test_modal();
			$('#send_test_email_form').get(0).setAttribute('action', '/emails/' + <%= @model.id.to_s %> + '/send_test');
			$('.modal_company_name').text('<%= @model.company.simple_name %>');
			$('#send_test_email_modal').modal('show');
		});

		$('.remove_btn').click(function(ev) {

			$('#remove_email_form').removeAttr('data-remote');
			$('#remove_email_form').get(0).setAttribute('action', '/emails/' + <%= @model.id.to_s %>);
			$('.modal_company_name').text('<%= @model.company.simple_name %>');
			$('#remove_email_modal').modal('show');

	});
	<% end %>

	var temp_id = -1;

	$('#main_form').on('submit', function(evt) {

		preprocess_data();

		if(!validate_tag_fields())
		{
			$('#warning_save_modal').modal('show');
			evt.preventDefault();
			return;
		}
	});

	function remove_recipient(id) {
		$('#email_address_' + id).fadeOut('slow', function() {
			$('#email_address_' + id).remove();
		});
	}

	$('#email_type').on('change', function() {
		$('#title').val(email_type_titles[$('#email_type').val()]);
	});

	$('#add_recipient_btn').on('click', function() {

		email_address = $('#new_recipient_field').val();

		if (!$('#new_recipient_field').val())
		{
			display_form_errors('<%= t('alert.email.fill_a_recipient') %>');

		} else if(already_present(email_address))
		{
			display_form_errors('<%= t('alert.email.duplicated_recipient') %>');
		} else if (validate_recipient_email(email_address))
		{
			line = '<tr id="email_address_' + temp_id + '"><td class="recipient_id" style="display:none;">' + temp_id + '</td><td class="recipient_email">' + email_address + '</td><td style="width: 30px; vertical-align:middle"><%= link_to image_tag("delete.png", :title =>  t('helpers.action.remove'), :class => 'remove_receipt_btn'), '#', :class => 'remove_receipt_btn' %></td></tr>';
			$('#recipients_table > tbody:last-child').append(line);
			temp_id = temp_id - 1;

			hide_all_messages();
			$('#new_recipient_field').val('');
		} else
		{
			display_form_errors('<%= t('alert.email.invalid_recipient') %>');
		}
	});

	function already_present(email_address)
	{
		var result = false;

		$('#recipients_table > tbody > tr').each(function() {
			if($(this).find('.recipient_email').html() == email_address) {
				result = true;
			}
		})

		return result;
	}
	function validate_recipient_email(email) {
		var regex = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
		return regex.test(email);
	}

	function validate_tag_fields()
	{
		return !(contains_all_tags($('#email_body').val()) && contains_all_tags($('#email_receipt_text').val()));
	}

	function contains_all_tags(text)
	{
		return text.indexOf("<%= t('tags.company') %>") == -1 || text.indexOf("<%= t('tags.value') %>") == -1 || text.indexOf("<%= t('tags.competence') %>") == -1;
	}

	$("#add_company_to_body_btn").on('click', function() {add_tag_to_field('email_body', '<%= t('tags.company') %>')});
	$("#add_value_to_body_btn").on('click', function() {add_tag_to_field('email_body', '<%= t('tags.value') %>')});
	$("#add_competence_to_body_btn").on('click', function() {add_tag_to_field('email_body', '<%= t('tags.competence') %>')});

	function add_tag_to_field(field, tag) {
	    var caretPos = document.getElementById(field).selectionStart;
	    var textAreaTxt = jQuery("#" + field).val();
	    jQuery("#" + field).val(textAreaTxt.substring(0, caretPos) + ' ' + tag + ' ' + textAreaTxt.substring(caretPos) );
	}

	function formated_recipients()
	{
		var array = '';

		$('#recipients_table > tbody > tr').each(function() {
			array = array.concat($(this).find('.recipient_email').html() + ', ');
		})

		return array.substring(0, array.length - 2);
	}

	function preprocess_data()
	{
		$('#email_recipients_array').val(formated_recipients());
	}

	$('body').on('click', '.remove_receipt_btn', function() {
    	id = $(this).parent().parent().find('.recipient_id').text();

		$('#email_address_' + id).fadeOut('slow', function() {
			$('#email_address_' + id).remove();
		});
	});

	var email_type_titles = new Array();
	<% EmailType.all.each do |type| %>
	  	email_type_titles['<%= type.id%>'] = '<%= type.email_title %>';
	<% end %>

</script>