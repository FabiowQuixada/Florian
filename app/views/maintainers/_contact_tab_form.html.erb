<div class="row">
	<div class="container-fluid">
		<div class="panel panel-default">
			<div id="contact_panel_header" class="panel-heading"><%= t('helpers.maintainer.new_contact') %></div>
			<div class="panel-body">

				<%= render 'shared/error_alert', id: 'contact' %>

				<div class="row">
					<div class="form-group col-md-12">
						<div id="contact_data">
							<%= render 'contacts/contact_form' %>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-12 right">
						<a href="javascript:void(0)" id="add_contact_btn" class="btn btn-primary btn-xs add_btn"><%= t('helpers.action.add') %></a>
						<a href="javascript:void(0)" id="cancel_contact_edition_btn" class="btn btn-primary btn-xs add_btn hidden"><%= t('helpers.action.cancel') %></a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-md-12">

		<table id="contacts_table" class="table table-striped table-condensed table-bordered unbreakable-table">
			<thead>
				<tr class="hidden-xs">
					<% I18n.with_options(scope: 'activerecord.attributes.contact') do |i18n| %>
						<th class="id-column admin-only"></th>
						<th><%= i18n.t :name %></th>
						<th><%= i18n.t :position %></th>
						<th class="hidden"></th>
						<th><%= i18n.t :telephone %></th>
						<th><%= i18n.t :celphone %></th>
						<th class="hidden"></th>
						<th class="icon-column-2"></th>
						<th class="icon-column-2"></th>
						<th class="hidden"></th>
					<% end %>
				</tr>
			</thead>
			<tbody>
				<%= no_records_row Contact.new, @model.contacts, 6 %>
				<%= render @model.contacts %>
			</tbody>
		</table>
	</div>
</div>

<%= f.hidden_field 'contacts_to_be_deleted' %>


<script>
	<%= render 'contact_tab_form.js' %>

	$(() => {
		$('#add_contact_btn').on('click', () => {
			contact = build_contact();

			if(validate_contact(contact)) {
				transient_contacts += 1;

				if(loaded_contact_id) {

					// View;
					$(`#contact_${loaded_contact_id} .contact_name`).text(contact.name);
					$(`#contact_${loaded_contact_id} .contact_position`).text(contact.position);
					$(`#contact_${loaded_contact_id} .contact_email_address`).text(contact.email);
					$(`#contact_${loaded_contact_id} .contact_telephone`).text(contact.telephone);
					$(`#contact_${loaded_contact_id} .contact_celphone`).text(contact.celphone);
					$(`#contact_${loaded_contact_id} .contact_fax`).text(contact.fax);

					// Params;
					$(`#maintainer_contacts_attributes_${loaded_contact_id}_name`).val(contact.name);
					$(`#maintainer_contacts_attributes_${loaded_contact_id}_position`).val(contact.position);
					$(`#maintainer_contacts_attributes_${loaded_contact_id}_email_address`).val(contact.email);
					$(`#maintainer_contacts_attributes_${loaded_contact_id}_telephone`).val(contact.telephone);
					$(`#maintainer_contacts_attributes_${loaded_contact_id}_celphone`).val(contact.celphone);
					$(`#maintainer_contacts_attributes_${loaded_contact_id}_fax`).val(contact.fax);

				} else {
					$.ajax({
						url: '<%= url_for(action: 'contact_row', controller: 'maintainers', only_path: false, protocol: 'http') %>', 
						data: { contact },
						success: result => $('#contacts_table > tbody:last-child').append(result)
					});

					contact_temp_id -= 1;
				}

				clean_contact_fields();
				$('#no_contacts_row').addClass('hidden');
			}
		});

		$('body').on('click', '.remove_contact_btn', e => {
			const elem = $(e.currentTarget);
			const id = elem.closest('.contact_row').find('.contact_id').text();

	        $(`#contact_${id}`).remove();

			transient_contacts -= 1;

			if(document.getElementById("contacts_table").rows.length == 2)
				$('#no_contacts_row').removeClass('hidden');

			if(id > 0) {
				$('#maintainer_contacts_to_be_deleted').val(`${$('#maintainer_contacts_to_be_deleted').val()}${id},`);
			}

			clean_contact_fields();
		});

		$('body').on('click', '.edit_contact_btn', e => {
			const elem = $(e.currentTarget);
			load_contact(elem.closest('.contact_row').find('.contact_id').text())
		});

		$('#cancel_contact_edition_btn').on('click', clean_contact_fields);

	});
</script>
