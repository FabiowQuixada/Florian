<div class="row">
	<div class="container-fluid">
		<div class="panel panel-default">
			<div id="contact_panel_header" class="panel-heading"><%= t('helpers.company.new_contact') %></div>
			<div class="panel-body">

				<%= render partial: 'shared/error_alert', locals: {id: 'contact'} %>

				<div class="row">
					<div class="form-group col-md-12">
						<div id="contact_data">
							<%= render partial: 'contacts/contact_form' %>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-12 right">
						<a href="javascript:void(0)" id="add_contact_btn" class="btn btn-primary btn-xs add_btn"><%= t('helpers.action.add') %></a>
						<a href="javascript:void(0)" id="cancel_contact_edition_btn" style="display:none;" class="btn btn-primary btn-xs add_btn"><%= t('helpers.action.cancel') %></a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-md-12">

		<table id="contacts_table" class="table table-striped table-condensed table-bordered unbreakable-table">
			<thead>
				<tr class="hidden-xs">
					<% I18n.with_options(scope: 'activerecord.attributes.contact') do |i18n| %>
					<th class="id-column admin-only"></th>
					<th><%= i18n.t :name %></th>
					<th><%= i18n.t :position %></th>
					<th style="display:none;"></th>
					<th><%= i18n.t :telephone %></th>
					<th><%= i18n.t :celphone %></th>
					<th style="display:none;"></th>
					<th class="icon-column" style="width: 32px;"></th>
					<th class="icon-column" style="width: 32px;"></th>
					<th style="display:none;"></th>
					<% end %>
				</tr>
			</thead>
			<tbody>
				<tr id="no_contacts_row"<%= ' style=display:none' if @model.contacts.any? %>><td colspan="10"><%= genderize_tag(Contact.new, 'helpers.none_registered') %></td></tr>

				<% @model.contacts.each do |contact| %>
					<%= render partial: contact %>
				<% end %>
			</tbody>
		</table>
	</div>
</div>

<%= hidden_field_tag 'contacts_to_be_deleted' %>

<script>

	var transient_contacts = 0;
	var contact_temp_id = -1;
	loaded_contact_id = null;

	$(function() {

		$('#add_contact_btn').on('click', function add_or_update_contact() {

			if(validate_contact()) {

				transient_contacts += 1;

				name = $('#temp_contact_name').val();
				position = $('#temp_contact_position').val();
				email = $('#temp_contact_email_address').val();
				telephone = $('#temp_contact_telephone').val();
				celphone = $('#temp_contact_celphone').val();
				fax = $('#temp_contact_fax').val();

				if(loaded_contact_id) {

					// View;
					$('#contact_' + loaded_contact_id + ' .contact_name').text(name);
					$('#contact_' + loaded_contact_id + ' .contact_position').text(position);
					$('#contact_' + loaded_contact_id + ' .contact_email').text(email);
					$('#contact_' + loaded_contact_id + ' .contact_telephone').text(telephone);
					$('#contact_' + loaded_contact_id + ' .contact_celphone').text(celphone);
					$('#contact_' + loaded_contact_id + ' .contact_fax').text(fax);

					// Params;
					$('#company_contacts_attributes_' + loaded_contact_id + '_name').val(name);
					$('#company_contacts_attributes_' + loaded_contact_id + '_position').val(position);
					$('#company_contacts_attributes_' + loaded_contact_id + '_email_address').val(email);
					$('#company_contacts_attributes_' + loaded_contact_id + '_telephone').val(telephone);
					$('#company_contacts_attributes_' + loaded_contact_id + '_celphone').val(celphone);
					$('#company_contacts_attributes_' + loaded_contact_id + '_fax').val(fax);

				} else {
					$.ajax({
						url: '<%= url_for(action: 'contact_row', controller: 'companies', only_path: false, protocol: 'http') %>', 
						data: {contact: {id: contact_temp_id, name: name, position: position, email_address: email, telephone: telephone, celphone: celphone, fax: fax}},
						success: function(result) {
							$('#contacts_table > tbody:last-child').append(result);
				    	}
					});

					contact_temp_id -= 1;
				}

				clean_contact_fields();
				$('#no_contacts_row').hide();
			}
		});

		function validate_contact() {

			valid = at_least_one_field_filled();

			if(!valid) {
				var errors = new Array();
				errors.push('<%= I18n.t('errors.contact.all_empty') %>');
				display_error(errors, 'contact');
			}

			return valid;
		}

		function at_least_one_field_filled() {

			var is_valid = false;

			$("#contact_data input").each(function() {
				if ($(this).val() !== "") {
					is_valid = true;
					return;
				}
			});

			return is_valid;
		}

		function load_contact(id) {

			loaded_contact_id = id;
			$('#cancel_contact_edition_btn').show();
			$('#add_contact_btn').text('<%= t('helpers.action.update') %>');
			$('#contact_panel_header').text('<%= t('helpers.company.edit_contact') %>');

			$('#temp_contact_name').val($('#contact_' + id + ' .contact_name').text());
			$('#temp_contact_position').val($('#contact_' + id + ' .contact_position').text());
			$('#temp_contact_email_address').val($('#contact_' + id + ' .contact_email_address').text());
			$('#temp_contact_telephone').val($('#contact_' + id + ' .contact_telephone').text());
			$('#temp_contact_celphone').val($('#contact_' + id + ' .contact_celphone').text());
			$('#temp_contact_fax').val($('#contact_' + id + ' .contact_fax').text());
		}

		function clean_contact_fields() {
			$('#temp_contact_name').val('');
			$('#temp_contact_position').val('');
			$('#temp_contact_email_address').val('');
			$('#temp_contact_telephone').val('');
			$('#temp_contact_celphone').val('');
			$('#temp_contact_fax').val('');

			loaded_contact_id = null;
			$('#cancel_contact_edition_btn').hide();
			$('#add_contact_btn').text('<%= t('helpers.action.add') %>');
			$('#contact_panel_header').text('<%= t('helpers.company.new_contact') %>');

			hide_errors_from_box('contact');
		}

		$('body').on('click', '.remove_contact_btn', function() {
			id = $(this).parent().parent().find('.contact_id').text();

	        $('#contact_' + id).remove();

			transient_contacts -= 1;

			if(document.getElementById("contacts_table").rows.length == 2)
				$('#no_contacts_row').show();

			if(id > 0) {
				$('#contacts_to_be_deleted').val($('#contacts_to_be_deleted').val() + id + ',');
			}
		});

		$('body').on('click', '.edit_contact_btn', function() {
			id = $(this).parent().parent().find('.contact_id').text();
			load_contact(id);
		});

		$('#cancel_contact_edition_btn').on('click', clean_contact_fields);

		function contact_field(id, field, value) {
			return '<input class="form-control" value="' + value + '" type="hidden" name="company[contacts_attributes][' + id + '][' + field + ']" id="company_contacts_attributes_' + id + '_' + field + '">'
		}

	});
</script>
