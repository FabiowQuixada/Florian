<%= form_for @model, :html=> {:id => 'main_form'} do |f| %>

	<%= render partial: "helpers/form_errors", locals: {model: @model} %>

	<ul class="nav nav-tabs">
		<li id="main_tab_0_title" class="active  clickable"><a>Geral</a></li>
		<li id="main_tab_1_title" class="clickable"><a><%= Donation.new.model_name.human(:count => 2) %></a></li>
		<li id="main_tab_2_title" class="clickable"><a><%= Contact.new.model_name.human(:count => 2) %></a></li>
	</ul>

	<div id="main_tab_0" class="general_tab">
		<div class="container-fluid tab_body">
			<div class="row">
				<div class="form-group col-md-6">
					<%= f.label :trading_name %>
					<%= f.text_field :trading_name, :class => 'form-control', :readonly => f.object.persisted? %>
				</div>

				<div class="form-group col-md-6">
					<%= f.label :name %>
					<%= f.text_field :name, :class => 'form-control', :readonly => f.object.persisted? %>
				</div>
			</div><div class="row">
				<div class="form-group col-md-6">
					<%= f.label :cnpj %>
					<%= f.text_field :cnpj, :class => 'form-control cnpj', :readonly => f.object.persisted? %>
				</div>

				<div class="form-group col-md-6">
					<%= f.label :address %>
					<%= f.text_field :address, :class => 'form-control' %>
				</div>
			</div><div class="row">
				<div class="form-group col-md-6">
					<%= f.label :cep %>
					<%= f.text_field :cep, :class => 'form-control cep' %>
				</div>

				<div class="form-group col-md-6">
					<%= f.label :neighborhood %>
					<%= f.text_field :neighborhood, :class => 'form-control' %>
				</div>
			</div><div class="row">
				<div class="form-group col-md-6">
					<%= f.label :city %>
					<%= f.text_field :city, :class => 'form-control' %>
				</div>

				<div class="form-group col-md-6">
					<%= f.label :state %>
					<%= f.select :state, BR_STATES, {:include_blank => t('helpers.select.prompt')}, { :class => 'form-control' } %>

				</div>
			</div><div class="row">
				<div class="form-group col-md-6">
					<%= f.label :email_address %>
					<div class="input-group">
						<span class="input-group-addon">@</span>
						<%= f.text_field :email_address, :class => 'form-control' %>
					</div>
				</div>

				<div class="form-group col-md-6">
					<%= f.label :website %>
					<%= f.text_field :website, :class => 'form-control' %>
				</div>
			</div><div class="row">
				<div class="form-group col-md-6">
					<%= f.label :category %>
					<%= f.select :category, CompaniesHelper::CATEGORIES, {:include_blank => t('helpers.select.prompt')}, { :class => 'form-control' } %>
				</div>

				<div class="form-group col-md-6">
					<%= f.label :group %>
					<%= f.select :group, CompaniesHelper::GROUPS, {:include_blank => t('helpers.select.prompt')}, { :class => 'form-control' } %>
				</div>
			</div><div class="row">

			<div class="form-group col-md-12">
				<%= f.label :remark %>
				<%= f.text_area :remark, :rows => 6, :class => 'form-control' %>
			</div>
		</div>
	</div>

	</div><div id="main_tab_1" class="contact_tab" style="display: none;">
		<div class="container-fluid tab_body">

			<div class="row">
				<div class="form-group col-md-12">

					<div class="row">
						<div class="form-group col-md-6">

							<%= f.label :first_parcel %>
						    	<div class="input-group date" data-behaviour='datepicker' >
						     		 <%= f.text_field :first_parcel, {:class => 'form-control'} %><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
							</div>
						</div><div class="form-group col-md-6">
							<%= label_tag t('activerecord.attributes.company.last_parcel')%>
							<%= text_field_tag :last_parcel, '', {:id => 'company_last_parcel', :class => 'form-control', readonly: true} %>
						</div>
						</div><div class="row">
						<div class="form-group col-md-4">
							<%= f.label :payment_frequency %>
							<%= f.select :payment_frequency, CompaniesHelper::PARCEL_FREQUENCIES, {:include_blank => t('helpers.select.prompt')}, { :class => 'form-control' } %>
						</div>
						<div class="form-group col-md-4">
							<%= f.label :payment_period %>
							<%= f.text_field :payment_period, :class => 'form-control numbers_only' %>
						</div>
						<div class="form-group col-md-4">
							<%= f.label :contract %>
							<%= f.select :contract, CompaniesHelper::CONTRACTS, {:include_blank => t('helpers.select.prompt')}, { :class => 'form-control' } %>
						</div>
					</div><div class="row">
	                                                    	<div class="container-fluid">
		                                                    	<div class="panel panel-default">
			                                                    	<div class="panel-heading"><%= t('helpers.company.new_donation') %></div>
			                                                    	<div class="panel-body">

				                                                    	<%= render partial: 'helpers/error_alert', locals: {id: 'donation'} %>

									<div class="form-group  col-md-3">
					                                                    <div class="input-group date" data-behaviour='datepicker' >
					                                                        <%= text_field_tag :donation_date, '',{:id => 'new_donation_date', :class => 'form-control datepicker input-sm donation_date new_donation_date'} %><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
					                                                    </div>
					                                         	</div><div class="form-group  col-md-3">
					                                                    <div class="input-group">
					                                                        <span class="input-group-addon">R$</span>
					                                                        <%= text_field_tag :value, '', :id => 'new_donation_value', :class => 'form-control money input-sm donation_value new_donation_value' %>
					                                                    </div>
				                                                    	</div><div class="form-group  col-md-6">
					                                                	<%= text_field_tag :remark, '', :id => 'new_donation_remark', :placeholder => t('activerecord.attributes.donation.remark'), :class => 'form-control input-sm donation_remark new_donation_remark' %>
				                                                    	</div>

									<div class="col-md-12">
										<div align="right">
											<a id="add_donation_btn" class="btn btn-primary btn-xs add_btn"></span><%= t('helpers.action.add') %></a>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div><div class="row">
						<div class="col-md-12">

							<table id="donations_table" class="table table-striped table-condensed table-bordered">
								<tr>
									<% I18n.with_options(scope: 'activerecord.attributes.donation') do |i18n| %>
										<th><%= i18n.t :date %></th>
										<th><%= i18n.t :value %></th>
										<th style="width: 50%"><%= i18n.t :remark %></th>
										<th></th>
									<% end %>
								</tr>
								<tbody>
									<% if @model.donations.empty? %>
										<tr id="no_donations_row"><td colspan="4"><%= genderize_tag(Donation.new, 'helpers.none_registered') %></td></tr>
									<% end %>

									<% @model.donations.each do |d| %>
										<%= render partial: 'donations/donation_fields', locals: {d: d} %>
									<% end %>

								</tbody>
							</table>
						</div>
					</div>
				</div>
				</div>
			</div>
		</div>

	</div><div id="main_tab_2" style="display: none;">
		<div class="container-fluid tab_body">

			<div class="row">
				<div class="form-group col-md-12">

					<ul class="nav nav-tabs">
						<% f.object.contacts.each_with_index do |contact, index| %>
							<li id="contact_tab_<%= index %>_title" class="<%= 'active ' if index == 0 %>clickable"><a><%= t('activerecord.attributes.company.contacts.contact_' + index.to_s) %></a></li>
						<% end %>
					</ul>

					<div class="container-fluid tab_body">
						<% f.object.contacts.each_with_index do |contact, index| %>
						<%= f.fields_for :contacts, contact do |ff| %>

							<%= ff.hidden_field :contact_type %>


								<div id="contact_tab_<%= index %>" class="contact_tab" style="<%= 'display: none;' if index != 0 %>">
									<div class="row">
										<div class="form-group col-md-4">
											<%= ff.label :name %>
											<%= ff.text_field :name, :class => 'form-control contact_name' %>
										</div>

										<div class="form-group col-md-4">
											<%= ff.label :position %>
											<%= ff.text_field :position, :class => 'form-control contact_position', :value => index != 0 ? t('activerecord.attributes.company.contacts.contact_' + index.to_s) : ff.object.position, :readonly => index != 0 %>
										</div>

										<div class="form-group col-md-4">
											<%= ff.label :email_address %>
											<div class="input-group">
												<span class="input-group-addon">@</span>
												<%= ff.text_field :email_address, :class => 'form-control' %>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="form-group col-md-4">
											<%= ff.label :telephone %>
											<%= ff.text_field :telephone, :class => 'form-control telephone' %>
										</div>

										<div class="form-group col-md-4">
											<%= ff.label :celphone %>
											<%= ff.text_field :celphone, :class => 'form-control celphone' %>
										</div>

										<div class="form-group col-md-4">
											<%= ff.label :fax %>
											<%= ff.text_field :fax, :class => 'form-control fax' %>
										</div>
									</div>
								</div>
						<% end %>
					<% end %>
					</div>
				</div>
			</div>
			</div>
	</div>

	<%= render partial: "helpers/form_buttons", locals: {model: @model, f: f} %>

<%end%>

<%= render partial: "helpers/tab_helper", locals: {tab_type: 'contact', number_of_tabs: 3} %>
<%= render partial: "helpers/tab_helper", locals: {tab_type: 'main', number_of_tabs: 3} %>
<%= render partial: "helpers/form_helper", locals: {model: @model} %>

<script>

	function preprocess_data()
	{
	}


$(function(){

	update_number_parcels();
	set_last_parcel_date();

	$('#company_first_parcel').datepicker({
	     onSelect:function(evt, ui){
	          set_last_parcel_date();
	     }});

	$('#company_payment_frequency').change(function()
	{
		update_number_parcels();
	});


	$('#company_payment_period').on('change', function() {
		set_last_parcel_date();
	});

	function update_number_parcels() {

		value = $('#company_payment_frequency').val();

		if(value && value != 7 && value != 8) {
			set_last_parcel_date();
			$('#company_payment_period').removeAttr('readonly', 'readonly');
		}
		else{
			$('#company_payment_period').val('').attr('readonly', 'readonly');
			$('#company_last_parcel').val('');
		}
	}

	function set_last_parcel_date()
	{
		first_date = $('#company_first_parcel').val();
		frequency = $('#company_payment_frequency').val();
		parcel_qty = $('#company_payment_period').val();
		last_date = $('#company_last_parcel');

		if(!first_date || ! frequency || !parcel_qty)
		{
			last_date.val('');
			return;
		}

		var frequency_type = 'days';
		var temp = parcel_qty;

		if(frequency == 1) {
			frequency_type = 'days';
		} else if(frequency == 2) {
			frequency_type = 'weeks';
		} else if(frequency == 3) {
			frequency_type = 'months';
		} else if(frequency == 4) {
			temp = 3;
			frequency_type = 'months';
		} else if(frequency == 5) {
			temp = 6;
			frequency_type = 'months';
		} else if(frequency == 6) {
			frequency_type = 'years';
		}

		last_date.val(moment(first_date, "DD/MM/YYYY").add((temp-1), frequency_type).format("DD/MM/YYYY"));
	}

   	$('body').on('click', '#new_donation_btn', function() {
	    set_datepicker();
	});

	$('#add_donation_btn').on('click', function add_donation() {

		if(validate_donation()) {

			date = $('#new_donation_date').val();
			value = 'R$ ' + $('#new_donation_value').val();
			remark = $('#new_donation_remark').val();

			temp_id = (new Date).getTime();

			line = 	'<tr class="persisted_donation" id="donation_' + temp_id + '">'+
				    	'<td class="donation_id" style="display:none;">' + temp_id + '</td>' +
				    	'<td class="donation_date">' + date + '<input class="form-control input-sm donation_remark new_donation_date" value="' + to_rails_date(date) + '" type="hidden" name="company[donations_attributes][' + temp_id + '][donation_date]" id="company_donations_attributes_' + temp_id + '_date"></td>'+
				    	'<td class="donation_value">' + value + '<input class="form-control input-sm donation_remark new_donation_value" value="' + value + '" type="hidden" name="company[donations_attributes][' + temp_id + '][value]" id="company_donations_attributes_' + temp_id + '_value"></td>'+
				    	'<td style="width: 50%" class="donation_remark">' + remark + '<input class="form-control input-sm donation_remark new_donation_remark" value="' + remark + '" type="hidden" name="company[donations_attributes][' + temp_id + '][remark]" id="company_donations_attributes_' + temp_id + '_remark"></td>' +
				    	'<td style="width: 16px;"><%= link_to image_tag("delete.png", :title =>  t('helpers.action.remove'), :class => 'remove_donation_btn'), 'javascript:void(0)', :class => 'remove_donation_btn' %></td>' +
				'</tr>';

			$('#donations_table > tbody:last-child').append(line);

			$('#new_donation_date').val('');
			$('#new_donation_value').val('0,00');
			$('#new_donation_remark').val('');

			$('#no_donations_row').hide();

			hide_errors_from_box('donation');
		}
	});

	function validate_donation() {

		var errors = new Array();

		if(!$('#new_donation_date').val())
			errors.push('<%= I18n.t('errors.donation.date_mandatory') %>');

		if((!$('#new_donation_value').val() || $('#new_donation_value').val() == '0,00') && !$('#new_donation_remark').val())
			errors.push('<%= I18n.t('errors.donation.value_or_remark') %>');

		if(errors.length > 0) {
			display_error('donation', errors);
		}

		return errors.length == 0;
	}

	$('body').on('click', '.remove_donation_btn', function() {
	        id = $(this).parent().parent().find('.donation_id').text();

	        //$('#donation_' + id).fadeOut('slow', function() {
	            $('#donation_' + id).remove();
	        //});

	        if(document.getElementById("donations_table").rows.length == 2)
	        	$('#no_donations_row').show();

	    });

});
</script>
