<%= form_for @model, html: { id: 'main_form' } do |f| %>

	<%= render 'shared/form_errors' %>

	<div class="container-fluid padless">
		<div class="row">
			<div class="col-md-5">
				<%= render 'shared/email_address_table', f: f, model: @model %>
			</div>
			<div class="col-md-7">

				<div class="container-fluid padless">
					<div class="row">
						<div class="col-sm-12 form-group">
							<%= f.label :maintainer %>
							<% if f.object.persisted? %>
								<%= f.collection_select(:maintainer_id, Maintainer.where(id: f.object.maintainer_id), :id, :name, {}, {id: 'receipt_email_maintainer', class: 'form-control', disabled: true}) %>
							<% else %>
								<%= f.collection_select(:maintainer_id, Maintainer.where(group: 1), :id, :name, {include_blank: t('helpers.select.prompt')}, {id: 'receipt_email_maintainer', class: 'form-control'}) %>
							<% end %>
						</div>
					</div><div class="row">
					<div class="col-sm-5 form-group">
						<%= f.label :value %>
						<div class="input-group">
							<span class="input-group-addon"><%= currency %></span>
							<%= money_field f, :value %>
						</div>
					</div>
					<div class="col-sm-4 form-group">
						<%= f.hidden_field :day_of_month, class: 'form-control day_of_month' %>
					</div>
				</div>
			</div>
		</div>
	</div>
	</div>

	<div class="form-group">
		<%= f.label :title %>
		<%= text_field_tag :title, @model.title(current_user), id: 'receipt_email_title', disabled: true, class: 'form-control' %>
	</div>

	<div class="form-group">
		<%= f.label :body %>
		<div style="float:right">
			<%= user_help_btn 'body_tag_help_btn' %>
			<% I18n.with_options(scope: 'activerecord.attributes.receipt_email') do |i18n| %>
				<div class="btn-group">
					<button type="button" class="btn btn-primary btn-xs" id="add_maintainer_to_body_btn"><%= i18n.t :maintainer %></button>
					<button type="button" class="btn btn-primary btn-xs" id="add_value_to_body_btn"><%= i18n.t :value %></button>
					<button type="button" class="btn btn-primary btn-xs" id="add_competence_to_body_btn"><%= i18n.t :competence %></button>
				</div>
			<% end %>
		</div>
		<%= f.text_area :body, size: '24x6', class: 'form-control' %>
	</div>

	<% if !@model.new_record? %>
		<div class="panel-group">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h4 class="panel-title"><a data-toggle="collapse" href="#collapse_history"><%= t('audit.history') %></a></h4>
				</div>
				<div id="collapse_history" class="panel-collapse collapse">
					<div class="panel-body marginless padless">
						<table id="history_table" class="table table-striped table-condensed">
							<thead>
								<tr>
									<th><%= t('audit.when') %></th>
									<th><%= t('audit.value') %></th>
									<th><%= t('audit.type') %></th>
									<th><%= t('audit.who') %></th>
								</tr>
							</thead>

							<tbody>
								<% @model.history.each do |history| %>
									<tr>
										<td><%= l(history.created_at, format: :really_short) %></td>
										<td><%= ActionController::Base.helpers.number_to_currency(history.value) %></td>
										<td><%= history.send_type_desc %></td>
										<td><%= history.user.name %></td>
									</tr>
								<% end %>
							</tbody>
						</table>
					</div>
					<div class="panel-footer">
					</div>
				</div>
			</div>
		</div>
	<% end #new_record? %>

	<%= render 'shared/form_status_button', f: f %>
	
	<br/>

	<div class="form-buttons">
	    <%= save_update_btn @model, f %>
	    <%= resend_form_btn @model %>
	    <%= send_test_form_btn @model %>
	    <%= form_back_btn %>
	</div>

<% end #main_form %>

<%= render 'shared/form_commons' %>
<%= render 'modals' %>

<script>

	function preprocess_data() {}

	$(function() {

		<% if @model.persisted? %>

			$('.resend_btn').click(function(ev) {

				clean_resend_modal();
				$('#resend_email_form').get(0).setAttribute('action', '<%= resend_receipt_email_path @model %>');
				$('.modal_maintainer_name').text('<%= @model.maintainer.name %>');
				$('#resend_email_modal').modal('show');
			});

			$('.send_test_btn').click(function(ev) {

				clean_send_test_modal();
				$('#send_test_email_form').get(0).setAttribute('action', '<%= send_test_receipt_email_path @model %>');
				$('.modal_maintainer_name').text('<%= @model.maintainer.name %>');
				$('#send_test_email_modal').modal('show');
			});

		<% end %>

		$('#body_tag_help_btn').click(function(ev) {
			display_confirm_modal('<%= I18n.t 'modal.title.info' %>', '<%= I18n.t 'user_help_messages.tag_buttons' %>');
		});

		$('#receipt_email_title').val(escape_html('<%= current_user.system_setting.re_title %>'));

		$('#main_form').on('submit', function(evt) {

			preprocess_data();

			if(!validate_tag_fields()) {
				$('#warning_save_modal').modal('show');
				evt.preventDefault();
				return;
			}
		});

		function validate_tag_fields() {
			return !contains_all_tags($('#receipt_email_body').val());
		}

		function contains_all_tags(text) {
			return text.indexOf("<%= t('tags.maintainer') %>") == -1 || text.indexOf("<%= t('tags.value') %>") == -1 || text.indexOf("<%= t('tags.competence') %>") == -1;
		}

		$("#add_maintainer_to_body_btn").on('click', function() {add_tag_to_field('receipt_email_body', '<%= t('tags.maintainer') %>')});
		$("#add_value_to_body_btn").on('click', function() {add_tag_to_field('receipt_email_body', '<%= t('tags.value') %>')});
		$("#add_competence_to_body_btn").on('click', function() {add_tag_to_field('receipt_email_body', '<%= t('tags.competence') %>')});

		function preprocess_data() {
			if(transient_recipients > 0) {
				window.any_changes = true;
			}

			$('#receipt_email_recipients_array').val(formated_recipients());
		}
	});

</script>